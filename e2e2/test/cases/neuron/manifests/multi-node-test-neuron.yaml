apiVersion: kubeflow.org/v2beta1
kind: MPIJob
metadata:
  name: multi-node-nccom-test
spec:
  slotsPerWorker: {{.NeuronPerNode}}
  runPolicy:
    backoffLimit: 20
    cleanPodPolicy: Running
  mpiReplicaSpecs:
    Launcher:
      replicas: 1
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - image: {{.NeuronTestImage}}
            imagePullPolicy: Always
            name: nccom-test-launcher
            command:
            - nccom-test
            - -x
            - CCOM_SOCKET_IFNAME=eth0
            - -x
            - NEURON_RT_ROOT_COMM_ID=multi-node-nccl-test-worker-0:63182
            - -r 
            - "{{.WorkerNodeNeuronCount}}"
            - -N
            - "{{.WorkerNodeCount}}"
            - -b
            - "8"
            - -e
            - "16G"
            - -f
            - "2"
            - -n
            - "50"
            - -w
            - "5"
            - -d 
            - "fp32"
            - allr
            - --debug
            ports:
            - containerPort: 63182
            - containerPort: 60006
            - containerPort: 22
    Worker:
      replicas: {{.WorkerNodeCount}}
      template:
        spec:
          containers:
          - image: {{.NeuronTestImage}}
            ports:
            - containerPort: 63182
            - containerPort: 60006
            - containerPort: 22
            name: nccom-test-worker
            imagePullPolicy: Always
            resources:
              limits:
                aws.amazon.com/neuron: {{.NeuronPerNode}}
                vpc.amazonaws.com/efa: {{.EfaInterfacePerNode}}
              requests:
                aws.amazon.com/neuron: {{.NeuronPerNode}}
                vpc.amazonaws.com/efa: {{.EfaInterfacePerNode}}